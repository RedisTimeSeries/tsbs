# TSBS Supplemental Guide: RedisTimeSeries

RedisTimeSeries is a Redis Module adding a Time Series data structure to Redis. This supplemental guide explains how
the data generated for TSBS is stored, additional flags available when
using the data importer (`tsbs_load_redistimeseries`). **This
should be read *after* the main README.**


---


## Installation

TSBS is a collection of Go programs (with some auxiliary bash and Python
scripts). The easiest way to get and install the Go programs is to use
`go get` and then `go install`:
```bash
# Fetch TSBS and its dependencies
$ go get github.com/timescale/tsbs
$ cd $GOPATH/src/github.com/timescale/tsbs/cmd
$ go get ./...

# Install redistimeseries binaries. 
cd $GOPATH/src/github.com/timescale/tsbs/cmd
cd tsbs_generate_data && go install
cd ../tsbs_generate_queries && go install
cd ../tsbs_load_redistimeseries && go install
cd ../tsbs_run_queries_redistimeseries && go install
cd $GOPATH/src/github.com/timescale/tsbs
```

## Full cycle TSBS RedisTimeSeries scripts

Instead of calling tsbs redistimeseries binaries directly, we also supply scripts/*.sh for convenience with many of the flags set to a reasonable default for RedisTimeSeries database. 

So for a Full cycle TSBS RedisTimeSeries benchmark, ensure that RedisTimeSeries is running and then use:

```
# generate the dataset 
FORMATS="redistimeseries" SKIP_IF_EXISTS=FALSE  SCALE=100 SEED=123 \
    scripts/generate_data.sh

# generate the queries
FORMATS="redistimeseries" SKIP_IF_EXISTS=FALSE SCALE=4000 SEED=123 \
    scripts/generate_queries.sh

# load the data into RedisTimeSeries
scripts/load_redistimeseries.sh

# benchmark RedisTimeSeries query performance
scripts/run_queries_redistimeseries.sh

```

## Data format

Data generated by `tsbs_generate_data` for RedisTimeSeries is serialized in
`key timestamp value [key timestamp value ...]` format. Each metric reading is composed of `key timestamp value`. In addition to metric readings, 'tags' (including the location of the host, its operating system, etc) are added to each distinct time series at the moment of the first insertion, using [TS.ADD](https://oss.redislabs.com/redistimeseries/commands/#tsadd).

An example for the `cpu-only` use case, on the first metric reading for the `cpu_usage_user{3297394792}`, `cpu_usage_system{3297394792}`, and `cpu_usage_idle{3297394792}` metrics, they would be insert using [TS.ADD](https://oss.redislabs.com/redistimeseries/commands/#tsadd), in the following manner:
```text
TS.ADD cpu_usage_user{3297394792} 1451606400000 58 LABELS hostname host_0 region eu-central-1 datacenter eu-central-1a rack 6 os Ubuntu15.10 arch x86 team SF service 19 service_version 1 service_environment test measurement cpu fieldname usage_user
TS.ADD cpu_usage_system{3297394792} 1451606400000 2 LABELS hostname host_0 region eu-central-1 datacenter eu-central-1a rack 6 os Ubuntu15.10 arch x86 team SF service 19 service_version 1 service_environment test measurement cpu fieldname usage_system
TS.ADD cpu_usage_idle{3297394792} 1451606400000 24 LABELS hostname host_0 region eu-central-1 datacenter eu-central-1a rack 6 os Ubuntu15.10 arch x86 team SF service 19 service_version 1 service_environment test measurement cpu fieldname usage_idle
```

The second and following metric readings for the `cpu_usage_user{3297394792}`, `cpu_usage_system{3297394792}`, and `cpu_usage_idle{3297394792}` metrics would be inserted using [TS.MADD](https://oss.redislabs.com/redistimeseries/commands/#tsmadd) command:

```text
TS.MADD cpu_usage_user{3297394792} 1451606410000 57 cpu_usage_system{3297394792} 1451606410000 3 cpu_usage_idle{3297394792}
TS.MADD cpu_usage_user{3297394792} 1451606420000 58 cpu_usage_system{3297394792} 1451606420000 2 cpu_usage_idle{3297394792}
```

## Query types <a name="tsbs-query-types-mapping"></a> mapping to RedisTimeSeries query language

### Devops / cpu-only

#### q1) single-groupby-1-1-1
Simple aggregrate (MAX) on one metric for 1 host, every 5 mins for 1 hour

Query language
```
"TS.MRANGE" "1451824006646" "1451827606646" \
            "AGGREGATION" "max" "300000" \
            "FILTER" "fieldname=usage_user" \
                     "hostname=host_1"
```

#### q2) single-groupby-1-1-12

Simple aggregrate (MAX) on one metric for 1 host, every 5 mins for 12 hours

Query language
```
"TS.MRANGE" "1451733760646" "1451776960646" \
            "AGGREGATION" "max" "300000" \
            "FILTER" "fieldname=usage_user" \
                     "hostname=host_1"
```

#### q3) single-groupby-1-8-1
Simple aggregrate (MAX) on one metric for 8 hosts, every 5 mins for 1 hour

Query language
```
"TS.MRANGE" "1451824006646" "1451827606646" \
             "AGGREGATION" "max" "300000" \
             "FILTER" "fieldname=usage_user" \
                      "hostname=(host_1,host_3,host_7,host_6,host_0,host_5,host_4,host_2)"
```


#### q4) single-groupby-5-1-1
 Simple aggregrate (MAX) on 5 metrics for 1 host, every 5 mins for 1 hour

Query language
```
"TS.MRANGE" "1451824006646" "1451827606646" \
            "AGGREGATION" "max" "300000" \
            "FILTER" "fieldname=(usage_user,usage_system,usage_idle,usage_nice,usage_iowait)" \
                     "hostname=host_1"
```


#### q5) single-groupby-5-1-12
Simple aggregrate (MAX) on 5 metrics for 1 host, every 5 mins for 12 hours

Query language
```
"TS.MRANGE" "1451733760646" "1451776960646" \
            "AGGREGATION" "max" "300000" \
            "FILTER" "fieldname=(usage_user,usage_system,usage_idle,usage_nice,usage_iowait)" \
                     "hostname=host_1"
```

#### q6) single-groupby-5-8-1
Simple aggregrate (MAX) on 5 metrics for 8 hosts, every 5 mins for 1 hour


Query language
```
"TS.MRANGE" "1451824006646" "1451827606646" \
            "AGGREGATION" "max" "300000" \
            "FILTER" "fieldname=(usage_user,usage_system,usage_idle,usage_nice,usage_iowait)" \
                     "hostname=(host_1,host_3,host_7,host_6,host_0,host_5,host_4,host_2)"
```

#### q7) cpu-max-all-1
Aggregate across all CPU metrics per hour over 1 hour for a single host

Query language
```
"TS.MRANGE" "1451648911646" "1451677711646" \
            "AGGREGATION" "max" "3600000" \
            "FILTER" "measurement=cpu" \
                     "hostname=host_1"
```

#### q8) cpu-max-all-8
Aggregate across all CPU metrics per hour over 1 hour for eight hosts

Query language
```
"TS.MRANGE" "1451648911646" "1451677711646" \
            "AGGREGATION" "max" "3600000" \
            "FILTER" "measurement=cpu" \
                     "hostname=(host_1,host_3,host_7,host_6,host_0,host_5,host_4,host_2)"
```

#### q9) double-groupby-1
Aggregate on across both time and host, giving the average of 1 CPU metric per host per hour for 24 hours


Query language
```
"TS.MRANGE" "1451733760646" "1451776960646" 
            "AGGREGATION" "avg" "3600000" 
            "FILTER" "measurement=cpu" 
                     "fieldname=(usage_user)"
```

#### q10) double-groupby-5
 Aggregate on across both time and host, giving the average of 5 CPU metrics per host per hour for 24 hours

``` 
"TS.MRANGE" "1451733760646" "1451776960646" \
            "AGGREGATION" "avg" "3600000" \
            "FILTER" "measurement=cpu" 
                     "fieldname=(usage_user,usage_system,usage_idle,usage_nice,usage_iowait)"
```

#### double-groupby-all
 Aggregate on across both time and host, giving the average of all (10) CPU metrics per host per hour for 24 hours

Query language
```
"TS.MRANGE" "1451733760646" "1451776960646" \
            "AGGREGATION" "avg" "3600000" \
            "FILTER" "measurement=cpu"
```

#### q11) high-cpu-all ( does not implement query )
All the readings where one metric is above a threshold across all hosts

Query language
```
TBD
```

#### q12) high-cpu-1 ( does not implement query )
 All the readings where one metric is above a threshold for a particular host

Query language
```
TBD
```

#### q13) lastpoint ( does not implement query )
The last reading for each host

Query language
```
TBD
```

#### q14) groupby-orderby-limit ( does not implement query )

The last 5 aggregate readings (across time) before a randomly chosen endpoint

Query language
```
TBD
```


---

## `tsbs_load_redistimeseries` Additional Flags

### Database related

#### `-host` (type: `string`, default: `localhost:6379`)

The host:port for Redis connection.

#### `-connections` (type: `int`, default: `10`)

The number of connections per worker.

#### `-pipeline` (type: `int`, default: `50`)

The pipeline's size. Read the full documentation [here](https://redis.io/topics/pipelining).

### Miscellaneous

#### `-single-queue` (type: `boolean`, default: `true`)

Whether to use a single queue.

#### `-check-chunks` (type: `int`, default: `0`)

Whether to perform post ingestion chunck count.
