# TSBS Supplemental Guide: RedisTimeSeries

RedisTimeSeries is a Redis Module adding a Time Series data structure to Redis. This supplemental guide explains how
the data generated for TSBS is stored, additional flags available when
using the data importer (`tsbs_load_redistimeseries`). **This
should be read *after* the main README.**


---
## Full cycle TSBS RedisTimeSeries scripts

Instead of calling tsbs redistimeseries binaries directly, we also supply scripts/*.sh for convenience with many of the flags set to a reasonable default for RedisTimeSeries database. 

So for a Full cycle TSBS RedisTimeSeries benchmark, ensure that RedisTimeSeries is running and then use:

```
# generate the dataset
FORMATS="redistimeseries" SKIP_IF_EXISTS=FALSE  SCALE=4000 SEED=123 \
    scripts/generate_data.sh

# generate the queries
FORMATS="redistimeseries" SKIP_IF_EXISTS=FALSE SCALE=4000 SEED=123 \
    scripts/generate_queries.sh

# load the data into RedisTimeSeries
scripts/load_redistimeseries.sh

# benchmark RedisTimeSeries query performance
scripts/run_queries_redistimeseries.sh

```

## Data format

Data generated by `tsbs_generate_data` for RedisTimeSeries is serialized in
`key timestamp value [key timestamp value ...]` format. Each metric reading is composed of `key timestamp value`. In addition to metric readings, 'tags' (including the location of the host, its operating system, etc) are added to each distinct time series at the moment of the first insertion, using [TS.ADD](https://oss.redislabs.com/redistimeseries/commands/#tsadd).

An example for the `cpu-only` use case, on the first metric reading for the `cpu_usage_user{3297394792}`, `cpu_usage_system{3297394792}`, and `cpu_usage_idle{3297394792}` metrics, they would be insert using [TS.ADD](https://oss.redislabs.com/redistimeseries/commands/#tsadd), in the following manner:
```text
TS.ADD cpu_usage_user{3297394792} 1451606400 58 LABELS hostname host_0 region eu-central-1 datacenter eu-central-1a rack 6 os Ubuntu15.10 arch x86 team SF service 19 service_version 1 service_environment test measurement cpu fieldname usage_user
TS.ADD cpu_usage_system{3297394792} 1451606400 2 LABELS hostname host_0 region eu-central-1 datacenter eu-central-1a rack 6 os Ubuntu15.10 arch x86 team SF service 19 service_version 1 service_environment test measurement cpu fieldname usage_system
TS.ADD cpu_usage_idle{3297394792} 1451606400 24 LABELS hostname host_0 region eu-central-1 datacenter eu-central-1a rack 6 os Ubuntu15.10 arch x86 team SF service 19 service_version 1 service_environment test measurement cpu fieldname usage_idle
```

The second and following metric readings for the `cpu_usage_user{3297394792}`, `cpu_usage_system{3297394792}`, and `cpu_usage_idle{3297394792}` metrics would be inserted using [TS.MADD](https://oss.redislabs.com/redistimeseries/commands/#tsmadd) command:

```text
TS.MADD cpu_usage_user{3297394792} 1451606410 57 cpu_usage_system{3297394792} 1451606410 3 cpu_usage_idle{3297394792}
TS.MADD cpu_usage_user{3297394792} 1451606420 58 cpu_usage_system{3297394792} 1451606420 2 cpu_usage_idle{3297394792}
```

## Query types <a name="tsbs-query-types-mapping"></a> mapping to RedisTimeSeries query language

### Devops / cpu-only

#### single-groupby-1-1-1
Simple aggregrate (MAX) on one metric for 1 host, every 5 mins for 1 hour

Query language
```
TBD
```

#### single-groupby-1-1-12

Simple aggregrate (MAX) on one metric for 1 host, every 5 mins for 12 hours

Query language
```
TBD
```

#### single-groupby-1-8-1
Simple aggregrate (MAX) on one metric for 8 hosts, every 5 mins for 1 hour

Query language
```
TBD
```


#### single-groupby-5-1-1| Simple aggregrate (MAX) on 5 metrics for 1 host, every 5 mins for 1 hour

Query language
```
TBD
```


#### single-groupby-5-1-12
Simple aggregrate (MAX) on 5 metrics for 1 host, every 5 mins for 12 hours

Query language
```
TBD
```

#### single-groupby-5-8-1
Simple aggregrate (MAX) on 5 metrics for 8 hosts, every 5 mins for 1 hour


Query language
```
TBD
```

#### cpu-max-all-1
Aggregate across all CPU metrics per hour over 1 hour for a single host

Query language
```
TBD
```

#### cpu-max-all-8
Aggregate across all CPU metrics per hour over 1 hour for eight hosts

Query language
```
TBD
```

#### double-groupby-1
Aggregate on across both time and host, giving the average of 1 CPU metric per host per hour for 24 hours


Query language
```
TBD
```

#### double-groupby-5
 Aggregate on across both time and host, giving the average of 5 CPU metrics per host per hour for 24 hours

#### double-groupby-all
 Aggregate on across both time and host, giving the average of all (10) CPU metrics per host per hour for 24 hours


Query language
```
TBD
```

#### high-cpu-all
All the readings where one metric is above a threshold across all hosts

Query language
```
TBD
```

#### high-cpu-1
 All the readings where one metric is above a threshold for a particular host

Query language
```
TBD
```

#### lastpoint
The last reading for each host

Query language
```
TBD
```

#### groupby-orderby-limit
The last 5 aggregate readings (across time) before a randomly chosen endpoint

Query language
```
TBD
```


---

## `tsbs_load_redistimeseries` Additional Flags

### Database related

#### `-host` (type: `string`, default: `localhost:6379`)

The host:port for Redis connection.

#### `-connections` (type: `int`, default: `10`)

The number of connections per worker.

#### `-pipeline` (type: `int`, default: `50`)

The pipeline's size. Read the full documentation [here](https://redis.io/topics/pipelining).

### Miscellaneous

#### `-single-queue` (type: `boolean`, default: `true`)

Whether to use a single queue.

#### `-check-chunks` (type: `int`, default: `0`)

Whether to perform post ingestion chunck count.
